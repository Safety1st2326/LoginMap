<!DOCTYPE html>
<html>
  <head>
    <title>Login Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXw6K-8U1ji11ZoVJXxsXfYYrPpRHJknM&callback=initMap"
      defer
    ></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      let map;
      let infoWindow;
      let markers = [];

      function getMarkerIcon(color) {
        return `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
      }

      async function loadMapData() {
        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbyxylbaGWKICSZWknf4dynlBU--JvoKiUVBmFGz_g0qvqwp4Tgqa_8xzybc2Cf1d-V3/exec");
          const locations = await response.json();

          // Clear old markers
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          const bounds = new google.maps.LatLngBounds();
          const stateColors = {};
          const availableColors = ["red", "blue", "green", "orange", "purple", "yellow", "pink", "gray", "brown"];
          let colorIndex = 0;

          locations.forEach(loc => {
            const position = {
              lat: parseFloat(loc.Latitude),
              lng: parseFloat(loc.Longitude)
            };
            bounds.extend(position);

            if (!stateColors[loc.State]) {
              stateColors[loc.State] = availableColors[colorIndex % availableColors.length];
              colorIndex++;
            }

            const marker = new google.maps.Marker({
              position,
              map,
              title: loc["Site ID"],
              icon: getMarkerIcon(stateColors[loc.State])
            });

            const content = `
              <div style="font-family: Arial; font-size: 14px;">
                <strong>Site ID:</strong> ${loc["Site ID"]}<br/>
                <strong>Site Name:</strong> ${loc["Site Name"]}<br/>
                <strong>Date:</strong> ${loc.Date}<br/>
                <strong>AGL:</strong> ${loc.AGL} ft<br/>
                <strong>Tower Type:</strong> ${loc["Tower Type"]}<br/>
                <strong>Latitude:</strong> ${loc.Latitude}<br/>
                <strong>Longitude:</strong> ${loc.Longitude}<br/>
                <strong>Street Address:</strong> ${loc["Street Address"]}<br/>
                <strong>City:</strong> ${loc.City}<br/>
                <strong>County:</strong> ${loc.County}<br/>
                <strong>State:</strong> ${loc.State}<br/>
                <strong>Postal Code:</strong> ${loc["Postal Code"]}<br/>
                <strong>PowerApps ID:</strong> ${loc["__PowerAppsId__"]}
              </div>
            `;

            marker.addListener("click", () => {
              infoWindow.setContent(content);
              infoWindow.open(map, marker);
            });

            markers.push(marker);
          });

          map.fitBounds(bounds);
        } catch (error) {
          console.error("Map load failed:", error);
        }
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 5,
          center: { lat: 39.8283, lng: -98.5795 } // Center of USA
        });
        infoWindow = new google.maps.InfoWindow();
        loadMapData();
        setInterval(loadMapData, 300000); // Refresh every 5 minutes
      }
    </script>
  </body>
</html>
